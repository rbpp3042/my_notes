---
layout: post
title: "Как установить прокси для n8n чтобы обойти блокировку сервисов по ip вашего сервера" 
---

Телеграм канал: [Синяя изолента, зубочистки и чатгпт](https://t.me/@blue_tape)

*Сначала опишу, что нужно делать, а потом дам подробный промт чтобы вы могли настроить это у себя с помощью любого AI и без знания кода.*

## План действий.

0. Исходим из того, что у вас уже установлен n8n на хостинге через докер, поэтому вы хотя бы немного знакомы с терминалом и контейнерами.

1. Сначала идем сюда и покупаем ipv4 прокси на этом сайте. Я никак не афилирован с ним, нашел в чате и использовал сам.

2. Сразу там же добавляем ip адрес вашего сервера в доверенные адреса для этого прокси.

3. Чтобы использовать купленный прокси ip адрес нам понадобиться установить впн-клиент в контейнер на вашем сервере. В моем примере это xray, но наверное подойдет любой.

4. При установке клиента сразу дайте ему рекизиты вашего прокси, чтобы он прописал их в конфиге xray.

5. Важное! После установки у меня долго не получалось отправлять запросы на https в n8n. Оказалось, что это какой-то косяк старых версий, который вылезает при работе через прокси. Подробнее не разбирался, но используйте свежие версии на (1.100.1 точно работает)


## Промт для AI-ассистента

<details>
<summary>Скопируйте весь текст ниже и отправьте его вашему AI-ассистенту.</summary>

```
Привет! Пожалуйста, помоги мне развернуть на моем VPS (ОС Ubuntu) стек приложений с помощью Docker.

**Задача:** Создать все необходимые конфигурационные файлы для запуска `n8n`, `PostgreSQL`, `Traefik` и `Xray`.

**Требования:**
- **Traefik** будет реверс-прокси для `n8n` с автоматическим SSL.
- **Xray** будет исходящим прокси для `n8n`.
- **n8n** должен использовать `PostgreSQL` и корректно работать с HTTPS-запросами через `Xray`.

Пожалуйста, создай для меня следующие файлы с указанным содержимым.

---

### 1. Файл `docker-compose.yml`

Создай файл `docker-compose.yml` со следующим содержимым.

Привет! Пожалуйста, помоги мне развернуть на моем VPS (ОС Ubuntu) стек приложений с помощью Docker.

**Задача:** Создать все необходимые конфигурационные файлы для запуска `n8n`, `PostgreSQL`, `Traefik` и `Xray`.

**Требования:**
- **Traefik** будет реверс-прокси для `n8n` с автоматическим SSL.
- **Xray** будет исходящим прокси для `n8n`.
- **n8n** должен использовать `PostgreSQL` и корректно работать с HTTPS-запросами через `Xray`.

Пожалуйста, создай для меня следующие файлы с указанным содержимым.

---

### 1. Файл `docker-compose.yml`

Создай файл `docker-compose.yml` со следующим содержимым.

yaml
version: "3.8"

services:
  traefik:
    image: traefik:v2.10
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    ports:
      # Замени на публичный IP твоего сервера
      - "YOUR_SERVER_IP:80:80"
      - "YOUR_SERVER_IP:443:443"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/traefik.yml:ro
      - ./traefik/acme.json:/acme.json
    networks:
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=web"

  xray:
    image: teddysun/xray
    container_name: xray
    restart: unless-stopped
    volumes:
      - ./xray/config.json:/etc/xray/config.json
    networks:
      - web

  postgres:
    image: postgres:15
    container_name: postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=<your-username>
      - POSTGRES_PASSWORD=<your-password>
      - POSTGRES_DB=n8n
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - web

  n8n:
    # Важно: версия 1.0.0+ для корректной работы HTTPS через прокси
    image: n8nio/n8n:1.100.1
    container_name: n8n
    restart: unless-stopped
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=<your-username>
      - DB_POSTGRESDB_PASSWORD=<your-password>
      - N8N_HOST=<your-domain>
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - NODE_TLS_REJECT_UNAUTHORIZED=0
      - N8N_PROXY_SERVER_URL=http://xray:10809
      - WEBHOOK_URL=https://<your-domain>
      - GENERIC_TIMEZONE=Europe/Moscow
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - web
    depends_on:
      postgres:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=web"
      - "traefik.http.routers.n8n.rule=Host(`<your-domain>`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls.certresolver=letsencrypt"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"

volumes:
  postgres_data:
  n8n_data:

networks:
  web:
    external: true
```

### 2. Файл traefik/traefik.yml
```

```yaml
entryPoints:
  web:
    address: ":80"
    http:
      redirections:
        entryPoint:
          to: websecure
          scheme: https

  websecure:
    address: ":443"

providers:
  docker:
    exposedByDefault: false

certificatesResolvers:
  letsencrypt:
    acme:
      email: your-email@example.com
      storage: acme.json
      httpChallenge:
        entryPoint: web
```

### 3. Файл xray/config.json
```

```json
{
  "log": {
    "loglevel": "warning"
  },
  "inbounds": [
    {
      "port": 10809,
      "listen": "0.0.0.0",
      "protocol": "http",
      "settings": {
        "timeout": 300
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "socks",
      "settings": {
        "servers": [
          {
            "address": "<proxy-ip>",
            "port": <proxy-port>,
            "users": [
              {
                "user": "<proxy-username>",
                "pass": "<proxy-password>"
              }
            ]
          }
        ]
      }
    }
  ]
}
```



## Команды для запуска
После того как я создам все файлы и заменю плейсхолдеры, я выполню эти команды:

```bash
# 1. Создаем внешнюю сеть для Traefik
docker network create web

# 2. Запускаем все сервисы
docker-compose up -d
```